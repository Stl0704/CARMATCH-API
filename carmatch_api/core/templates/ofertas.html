{% extends "base.html" %}
{% block title %}Ofertas | CarMatch{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    .skeleton { background:#eef1f4; border-radius:12px; height:140px; animation:pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
    .card:hover { transform:translateY(-2px); transition:transform .15s ease; }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h1 class="h4 m-0"><i class="bi bi-bag-check me-2"></i>Ofertas</h1>
    <div class="d-flex gap-2">
      <div class="input-group" style="max-width: 360px;">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="q" class="form-control" placeholder="Buscar por producto o tienda…">
      </div>
      <select id="sort" class="form-select" style="max-width: 220px;">
        <option value="relevancia">Ordenar: Relevancia</option>
        <option value="precio_asc">Precio ↑</option>
        <option value="precio_desc">Precio ↓</option>
        <option value="nombre_asc">Producto A–Z</option>
        <option value="nombre_desc">Producto Z–A</option>
      </select>
    </div>
  </div>

  <div id="state" class="mb-3"></div>

  <div id="grid" class="row g-3">
    <div class="col-12 col-sm-6 col-lg-4"><div class="skeleton"></div></div>
    <div class="col-12 col-sm-6 col-lg-4"><div class="skeleton"></div></div>
    <div class="col-12 col-sm-6 col-lg-4"><div class="skeleton"></div></div>
  </div>

  <!-- Paginador -->
  <div class="d-flex align-items-center justify-content-between mt-3">
    <div id="range" class="text-muted small"></div>
    <div class="btn-group">
      <button id="prev" class="btn btn-outline-secondary btn-sm" disabled>« Anterior</button>
      <button id="next" class="btn btn-outline-secondary btn-sm" disabled>Siguiente »</button>
    </div>
  </div>
</div>

<script>
(() => {
  const API_URL = "{% url 'ofertas-list' %}"; // /api/ofertas/

  const grid  = document.getElementById("grid");
  const state = document.getElementById("state");
  const q     = document.getElementById("q");
  const sort  = document.getElementById("sort");

  const btnPrev = document.getElementById("prev");
  const btnNext = document.getElementById("next");
  const rangeEl = document.getElementById("range");

  let PAGE = 1;
  let COUNT = 0;
  let PAGE_SIZE = 20; // Debe coincidir con DRF PAGE_SIZE si lo definiste globalmente
  let NEXT_URL = null;
  let PREV_URL = null;

  const money = (n) => {
    if (n === null || n === undefined || n === "") return "—";
    const num = Number(n);
    if (Number.isNaN(num)) return "—";
    return num.toLocaleString("es-CL", { style: "currency", currency: "CLP", maximumFractionDigits: 0 });
  };

  const setState = (html='') => { state.innerHTML = html; };

  const card = (item) => `
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="pe-2">
            <h5 class="card-title mb-1 line-clamp-2">
              <i class="bi bi-tag me-2"></i>${item.nombre}
            </h5>
            <div class="text-muted small">Tienda: ${item.tienda ?? '—'}</div>
            <div class="text-muted small">Oferta #${item.id}</div>
          </div>
          <div class="fs-5 fw-semibold text-nowrap">${money(item.precio)}</div>
        </div>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0 pb-3">
        <a class="btn btn-primary btn-sm" href="${item.url ?? '#'}" target="_blank" rel="noopener">
          <i class="bi bi-box-arrow-up-right me-1"></i> Ver detalle
        </a>
        <button class="btn btn-outline-secondary btn-sm ms-2" type="button">
          <i class="bi bi-plus-circle me-1"></i> Agregar
        </button>
      </div>
    </div>
  `;

  function render(items) {
    grid.innerHTML = "";
    if (!items.length) {
      setState('<div class="alert alert-warning mb-0"><i class="bi bi-emoji-neutral me-2"></i>Sin resultados.</div>');
      rangeEl.textContent = "";
      btnPrev.disabled = true;
      btnNext.disabled = true;
      return;
    }
    setState("");
    for (const it of items) {
      const col = document.createElement("div");
      col.className = "col-12 col-sm-6 col-lg-4";
      col.innerHTML = card(it);
      grid.appendChild(col);
    }
  }

  function orderingParam() {
    switch (sort.value) {
      case "precio_asc":  return "latest_price";
      case "precio_desc": return "-latest_price";
      case "nombre_asc":  return "product__name";
      case "nombre_desc": return "-product__name";
      default: return ""; // relevancia / por defecto
    }
  }

  function buildUrl(page=1) {
    const params = new URLSearchParams();
    params.set("page", page);
    const s = q.value.trim();
    if (s) params.set("search", s); // DRF SearchFilter
    const ord = orderingParam();
    if (ord) params.set("ordering", ord);
    return `${API_URL}?${params.toString()}`;
  }

  async function load(page=1, urlOverride=null) {
    try {
      setState('<div class="alert alert-secondary mb-0"><span class="spinner-border spinner-border-sm me-2"></span>Cargando…</div>');
      const url = urlOverride || buildUrl(page);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Error al consultar el API");

      const data = await res.json();
      const results = data.results || [];
      COUNT = data.count ?? results.length;
      PAGE = page;
      NEXT_URL = data.next;
      PREV_URL = data.previous;

      const start = (PAGE - 1) * PAGE_SIZE + 1;
      const end = Math.min(PAGE * PAGE_SIZE, COUNT);
      rangeEl.textContent = COUNT ? `Mostrando ${start}–${end} de ${COUNT}` : "";

      btnPrev.disabled = !PREV_URL;
      btnNext.disabled = !NEXT_URL;

      const items = results.map(o => ({
        id: o.id,
        nombre: o.product?.name ?? "(sin nombre)",
        tienda: o.store?.name ?? null,
        precio: o.latest_price ?? null,
        url: o.url ?? null,
      }));

      render(items);
    } catch (err) {
      console.error(err);
      setState('<div class="alert alert-danger mb-0"><i class="bi bi-x-octagon me-2"></i>No se pudo cargar la página.</div>');
    }
  }

  q.addEventListener("input", () => load(1));        // nueva búsqueda → vuelve a página 1
  sort.addEventListener("change", () => load(PAGE)); // re-ordena manteniendo página si se puede
  btnPrev.addEventListener("click", () => PREV_URL ? load(PAGE - 1, PREV_URL) : null);
  btnNext.addEventListener("click", () => NEXT_URL ? load(PAGE + 1, NEXT_URL) : null);

  load(1);
})();
</script>
{% endblock %}
