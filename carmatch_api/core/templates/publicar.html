{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Mis publicaciones | CarMatch{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  .card:hover {
    transform: translateY(-2px);
    transition: transform .15s ease;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .listing-photo {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: .5rem .5rem 0 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h1 class="h4 m-0">
      <i class="bi bi-megaphone me-2"></i>Mis publicaciones
    </h1>
    <div class="text-muted small">
      Hola, {{ user_name|default:"usuario" }} ðŸ‘‹
    </div>
  </div>

  <!-- Mensajes (Ã©xito / error) -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Formulario nueva publicaciÃ³n -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <strong><i class="bi bi-plus-circle me-2"></i>Crear nueva publicaciÃ³n</strong>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}

        <div class="col-12 col-md-6">
          <label class="form-label">{{ form.title.label }}</label>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="text-danger small">{{ form.title.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">{{ form.category.label }}</label>
          {{ form.category }}
          {% if form.category.errors %}
            <div class="text-danger small">{{ form.category.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-12">
          <label class="form-label">{{ form.description.label }}</label>
          {{ form.description }}
          {% if form.description.errors %}
            <div class="text-danger small">{{ form.description.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">{{ form.stock.label }}</label>
          {{ form.stock }}
          {% if form.stock.errors %}
            <div class="text-danger small">{{ form.stock.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">{{ form.price.label }}</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            {{ form.price }}
          </div>
          {% if form.price.errors %}
            <div class="text-danger small">{{ form.price.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">{{ form.photo.label }}</label>
          {{ form.photo }}
          {% if form.photo.errors %}
            <div class="text-danger small">{{ form.photo.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-cloud-upload me-1"></i> Publicar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Listado de publicaciones del usuario -->
  <h2 class="h5 mb-3">
    <i class="bi bi-card-checklist me-2"></i>Publicaciones creadas
  </h2>

  {% if publicaciones %}
    <div class="row g-3">
      {% for pub in publicaciones %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            {% if pub.photo %}
              <img src="{{ pub.photo.url }}" alt="{{ pub.title }}" class="listing-photo">
            {% else %}
              <div class="d-flex align-items-center justify-content-center bg-light listing-photo">
                <i class="bi bi-image text-muted" style="font-size: 2.5rem;"></i>
              </div>
            {% endif %}
            <div class="card-body">
              <h5 class="card-title mb-1 line-clamp-2">
                <i class="bi bi-tools me-1"></i>{{ pub.title }}
              </h5>

              <div class="text-muted small mb-1">
                {% if pub.category %}
                  {{ pub.category.name }}
                {% else %}
                  Sin categorÃ­a
                {% endif %}
              </div>

              <p class="card-text small mb-2">
                {{ pub.description|truncatechars:120 }}
              </p>

              <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-secondary">
                  Stock: {{ pub.stock }}
                </span>
                <span class="fw-semibold">
                  {{ pub.price|floatformat:0 }} CLP
                </span>
              </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0 pb-3 d-flex justify-content-between align-items-center small text-muted">
              <span>
                <i class="bi bi-clock-history me-1"></i>
                {{ pub.created_at|date:"d/m/Y H:i" }}
              </span>
              <!-- futuro: botones editar / eliminar -->
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning">
      <i class="bi bi-emoji-neutral me-2"></i>
      AÃºn no has creado ninguna publicaciÃ³n. Â¡Empieza con el formulario de arriba!
    </div>
  {% endif %}
</div>
{% endblock %}
