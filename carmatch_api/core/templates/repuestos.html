{% extends "base.html" %}
{% block title %}Repuestos | CarMatch{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    .skeleton { background: #eef1f4; border-radius: 12px; height: 140px; animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
    .card:hover { transform: translateY(-2px); transition: transform .15s ease; }
    .line-clamp-2 {
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h1 class="h4 m-0"><i class="bi bi-tools me-2"></i>Repuestos</h1>
    <div class="d-flex gap-2">
      <div class="input-group" style="max-width: 360px;">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="q" class="form-control" placeholder="Buscar por nombre…">
      </div>
      <select id="sort" class="form-select" style="max-width: 200px;">
        <option value="relevancia">Ordenar: Relevancia</option>
        <option value="precio_asc">Precio ↑</option>
        <option value="precio_desc">Precio ↓</option>
        <option value="nombre_asc">Nombre A–Z</option>
        <option value="nombre_desc">Nombre Z–A</option>
      </select>
    </div>
  </div>

  <div id="state" class="mb-3"></div>

  <div id="grid" class="row g-3">
    <div class="col-12 col-sm-6 col-lg-4"><div class="skeleton"></div></div>
    <div class="col-12 col-sm-6 col-lg-4"><div class="skeleton"></div></div>
    <div class="col-12 col-sm-6 col-lg-4"><div class="skeleton"></div></div>
  </div>
</div>

<script>
(() => {
  // Usa el basename que registraste en el router: basename="ofertas" -> 'ofertas-list'
  const API_URL = "{% url 'ofertas-list' %}"; // genera /api/ofertas/

  const grid  = document.getElementById("grid");
  const state = document.getElementById("state");
  const q     = document.getElementById("q");
  const sort  = document.getElementById("sort");

  let DATA = []; // [{id, nombre, precio, tienda, url}]

  const money = (n) => {
    if (n === null || n === undefined || n === "") return "—";
    const num = Number(n);
    if (Number.isNaN(num)) return "—";
    return num.toLocaleString("es-CL", { style: "currency", currency: "CLP", maximumFractionDigits: 0 });
  };

  const setState = (html='') => { state.innerHTML = html; };

  const card = (item) => `
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="pe-2">
            <h5 class="card-title mb-1 line-clamp-2">
              <i class="bi bi-wrench-adjustable-circle me-2"></i>${item.nombre}
            </h5>
            <div class="text-muted small">Tienda: ${item.tienda ?? '—'}</div>
            <div class="text-muted small">ID oferta: ${item.id}</div>
          </div>
          <div class="fs-5 fw-semibold text-nowrap">${money(item.precio)}</div>
        </div>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0 pb-3">
        <a class="btn btn-primary btn-sm" href="${item.url ?? '#'}" target="_blank" rel="noopener">
          <i class="bi bi-box-arrow-up-right me-1"></i> Ver detalle
        </a>
        <button class="btn btn-outline-secondary btn-sm ms-2" type="button">
          <i class="bi bi-plus-circle me-1"></i> Agregar
        </button>
      </div>
    </div>
  `;

  function render(items) {
    grid.innerHTML = "";
    if (!items.length) {
      setState('<div class="alert alert-warning mb-0"><i class="bi bi-emoji-neutral me-2"></i>Sin resultados.</div>');
      return;
    }
    setState("");
    for (const it of items) {
      const col = document.createElement("div");
      col.className = "col-12 col-sm-6 col-lg-4";
      col.innerHTML = card(it);
      grid.appendChild(col);
    }
  }

  function applyFilters() {
    const term = q.value.trim().toLowerCase();
    let items = !term ? [...DATA] : DATA.filter(x => (x.nombre || "").toLowerCase().includes(term));

    switch (sort.value) {
      case "precio_asc":  items.sort((a,b)=> (Number(a.precio) || 0) - (Number(b.precio) || 0)); break;
      case "precio_desc": items.sort((a,b)=> (Number(b.precio) || 0) - (Number(a.precio) || 0)); break;
      case "nombre_asc":  items.sort((a,b)=> String(a.nombre||"").localeCompare(String(b.nombre||""), 'es')); break;
      case "nombre_desc": items.sort((a,b)=> String(b.nombre||"").localeCompare(String(a.nombre||""), 'es')); break;
      default: break;
    }
    render(items);
  }

  async function load() {
    try {
      setState('<div class="alert alert-secondary mb-0"><span class="spinner-border spinner-border-sm me-2"></span>Cargando repuestos…</div>');
      const res = await fetch(API_URL, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Error al consultar el API");

      const data = await res.json();
      const results = Array.isArray(data) ? data : (data.results || []); // soporta paginación DRF

      // Normaliza OfferProduct -> tu UI
      // Espera que el serializer exponga: product.name, store.name, url, latest_price
      DATA = results.map(o => ({
        id: o.id,
        nombre: o.product?.name ?? "(sin nombre)",
        precio: o.latest_price ?? null,
        tienda: o.store?.name ?? null,
        url: o.url ?? null,
      }));

      setState("");
      applyFilters();
    } catch (err) {
      console.error(err);
      setState('<div class="alert alert-danger mb-0"><i class="bi bi-x-octagon me-2"></i>No se pudieron cargar los repuestos.</div>');
      grid.innerHTML = "";
    }
  }

  q.addEventListener("input", applyFilters);
  sort.addEventListener("change", applyFilters);
  load();
})();
</script>
{% endblock %}
